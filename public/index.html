<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Top 100 zkLink Rich Address List - Updated Every Hour</title>
  <link rel="icon" href="/favicon.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #121212;
      color: #ccc;
      font-family: 'Roboto', sans-serif;
      padding: 20px;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      min-height:100vh;
    }
    .container {
      width:100%;
      max-width:1100px;
      background:#1e1e1e;
      border-radius:8px;
      padding:24px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.6);
    }
    h1 { color:#fff; text-align:center; margin-bottom:12px; font-size:1.8rem; }
    .top-actions { display:flex; gap:12px; justify-content:center; margin-bottom:14px; flex-wrap:wrap; }
    .btn {
      background:#333; color:#fff; padding:8px 12px; border-radius:6px; text-decoration:none; cursor:pointer; border:1px solid #444;
    }
    .btn.secondary { background:transparent; color:#bbb; border:1px solid #333; }
    .status { text-align:center; margin-top:10px; color:#999; font-size:0.95rem; }

    table { width:100%; border-collapse:collapse; margin-top:18px; background:#272727; border-radius:6px; overflow:hidden; }
    thead th { padding:12px 14px; background:#333; color:#eee; text-align:left; font-weight:500; }
    tbody td { padding:12px 14px; border-bottom:1px solid #333; font-size:0.95rem; }
    tbody tr:hover { background:#2a2a2a; }
    .nowrap { white-space:nowrap; }

    .footer { margin-top:18px; color:#888; font-size:0.9rem; text-align:center; }
    .small-links a { color:#bb86fc; text-decoration:none; display:inline-block; margin:0 6px; }

    /* mobile */
    @media (max-width:768px) {
      table, thead, tbody, th, td, tr { display:block; width:100%; }
      thead { display:none; }
      tr { margin-bottom:12px; background:#272727; padding:12px; border-radius:6px; }
      td { padding:6px 0; border:none; }
      td::before { content: attr(data-label); display:inline-block; width:110px; color:#bbb; font-weight:500; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="page-title">Top 100 zkLink Rich Address List</h1>

    <div class="top-actions">
      <button class="btn" id="refresh-btn">Refresh Now</button>
      <button class="btn secondary" id="save-wayback-btn">Save snapshot to Wayback</button>
      <a class="btn secondary" id="open-wayback" href="https://web.archive.org/web/*/https://zkltop100.net" target="_blank">View Wayback History</a>
    </div>

    <div class="status" id="status">Loading data…</div>

    <table id="balances-table" aria-live="polite">
      <thead>
        <tr>
          <th style="width:60px">Rank</th>
          <th>Address / Label</th>
          <th class="nowrap" style="width:150px">Quantity</th>
          <th class="nowrap" style="width:110px">Percentage</th>
        </tr>
      </thead>
      <tbody>
        <!-- rows inserted by JS -->
      </tbody>
    </table>

    <div class="footer">
      <p>
        <strong>Reference</strong><br>
        <a class="small-links" href="https://explorer-api.zklink.io/docs#/" target="_blank">zkLink Explorer API</a> |
        <a class="small-links" href="https://www.coingecko.com/en/coins/zklink" target="_blank">CoinGecko ZKL</a>
      </p>
      <p>Created by <a href="https://x.com/modeler_zkl" target="_blank">@modeler_zkl</a></p>
    </div>
  </div>

  <script>
    const refreshBtn = document.getElementById('refresh-btn');
    const saveBtn = document.getElementById('save-wayback-btn');
    const statusEl = document.getElementById('status');
    const tbody = document.querySelector('#balances-table tbody');
    const pageTitle = document.getElementById('page-title');

    // Update title with price (CoinGecko). If fails, leave default.
    async function fetchCurrentPrice() {
      try {
        const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=zklink&vs_currencies=usd');
        const j = await r.json();
        if (j && j.zklink && typeof j.zklink.usd === 'number') {
          const p = j.zklink.usd;
          document.title = `ZKL $${p.toFixed(3)} | Top 100 zkLink Rich Address List`;
          pageTitle.textContent = `Top 100 zkLink Rich Address List — ZKL $${p.toFixed(3)}`;
          return p;
        }
      } catch (e) {
        console.warn('price fetch failed', e);
      }
      return 0;
    }

    async function fetchBalancesAndRender() {
      statusEl.textContent = 'Fetching balances...';
      try {
        const r = await fetch('/get-balances');
        if (!r.ok) throw new Error('Bad response');
        const list = await r.json();
        tbody.innerHTML = '';
        if (!Array.isArray(list) || list.length === 0) {
          statusEl.textContent = 'No data available.';
          return;
        }
        // compute total from rawBalance (server already provides percentage but we'll show consistent values)
        const total = list.reduce((s, it) => s + (Number(it.rawBalance) || 0), 0);

        list.forEach(item => {
          const tr = document.createElement('tr');
          const balanceNumber = Number(item.rawBalance) || 0;
          const formattedQty = (balanceNumber).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ZKL';
          const percent = total > 0 ? (balanceNumber / total * 100) : 0;
          tr.innerHTML = `
            <td data-label="Rank">${item.Ranking}</td>
            <td data-label="Address">${item.label ? `<strong>${item.label}</strong><br>` : ''}<a href="https://explorer.zklink.io/address/${item.address}" target="_blank" rel="noopener noreferrer">${item.address}</a></td>
            <td class="nowrap" data-label="Quantity">${formattedQty}</td>
            <td class="nowrap" data-label="Percentage">${percent.toFixed(6)}%</td>
          `;
          tbody.appendChild(tr);
        });

        statusEl.textContent = `Loaded ${list.length} addresses — last updated: ${new Date().toLocaleString()}`;
      } catch (err) {
        console.error('fetchBalances error', err);
        statusEl.textContent = 'Failed to load balances.';
      }
    }

    // Save snapshot to Wayback via server endpoint
    async function saveToWayback() {
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving…';
      statusEl.textContent = 'Requesting Wayback snapshot...';
      try {
        // default target can be this site; change if you want to save another URL
        const targetUrl = window.location.origin; // e.g. https://your-deployed-app.onrender.com
        const r = await fetch('/save-to-archive', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: targetUrl })
        });
        const j = await r.json();
        if (r.ok && j.success && j.snapshot) {
          statusEl.innerHTML = `Saved to Wayback: <a href="${j.snapshot}" target="_blank">${j.snapshot}</a>`;
        } else if (j.manualSaveUrl) {
          statusEl.innerHTML = `Save accepted but snapshot URL not returned. Try manual: <a href="${j.manualSaveUrl}" target="_blank">${j.manualSaveUrl}</a>`;
        } else {
          statusEl.textContent = j.error || j.message || 'Wayback save failed';
        }
      } catch (err) {
        console.error('saveToWayback failed', err);
        statusEl.textContent = 'Wayback save request failed';
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save snapshot to Wayback';
      }
    }

    refreshBtn.addEventListener('click', async () => {
      refreshBtn.disabled = true;
      refreshBtn.textContent = 'Refreshing…';
      await fetchCurrentPrice();
      await fetchBalancesAndRender();
      refreshBtn.disabled = false;
      refreshBtn.textContent = 'Refresh Now';
    });
    saveBtn.addEventListener('click', saveToWayback);

    // initial load
    (async () => {
      await fetchCurrentPrice();
      await fetchBalancesAndRender();
      // auto-refresh every hour (client-side). Render hobby doesn't support cron; if you need server cron use external scheduler.
      setInterval(fetchBalancesAndRender, 60 * 60 * 1000);
    })();
  </script>
</body>
</html>
